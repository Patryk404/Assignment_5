Xlab = "Year",
Legend = c("Samoa", "Synthetic Samoa"),
Legend.position = "bottomleft",
Main = "Samoa vs Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
# Gap plot (treatment effect)
gaps.plot(
synth.res = synth_out,
dataprep.res = dataprep_out,
Ylab = "Gap in Fatalities",
Xlab = "Year",
Main = "Gap between Samoa and Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
abline(h = 0, lty = 2, col = "gray")
# Treatment effects
# Extracting actual and synthetic values
actual <- dataprep_out$Y1plot
synthetic <- dataprep_out$Y0plot %*% synth_out$solution.w
treatment_effect <- actual - synthetic
# Post-treatment average effect
post_treatment_effect <- mean(treatment_effect[10:17]) # 2009-2016
print(paste("\nAverage Post-Treatment Effect:", round(post_treatment_effect, 2)))
# Results dataframe
results_df <- data.frame(
year = 2000:2016,
actual = as.vector(actual),
synthetic = as.vector(synthetic),
gap = as.vector(treatment_effect)
)
print("\nYear-by-Year Results:")
print(results_df)
install.packages(c("dplyr", "modelsummary"))
install.packages(c("dplyr", "modelsummary"))
library(dplyr)
library(modelsummary)
df_pre <- df %>%
mutate(treated = country == "Samoa") %>%
filter(year <= 2008)
vars <- c("fatalities", "gdp_pc", "alcohol", "pop_density")
summary_tbl <- datasummary(
treated ~ (fatalities + gdp_pc + alcohol + pop_density),
data = df_pre,
statistic = c("Mean" = "mean", "SD" = "sd"),
fmt = 2
)
diff_tbl <- datasummary(
All(df_pre[, vars]) ~ Difference,
data = df_pre,
by = "treated",
statistic = "({mean[1]} - {mean[2]}){stars}",
fmt = 2
)
summary_tbl + diff_tbl
View(synthetic)
View(synthetic)
View(treatment_effect)
View(synth_tables)
View(synth_out)
View(synth_tables)
View(results_df)
install.packages("stargazer")
library(stargazer)
stargazer(
data,
type = "latex",
title = "Summary Statistics",
digits = 2,
summary.stat = c("n", "mean", "sd", "min", "max")
)
# Install if needed
install.packages("stargazer")
library(stargazer)
# Basic summary statistics table
stargazer(df,
type = "latex",
summary = TRUE,
title = "Summary Statistics",
digits = 2)
# Save to file
stargazer(df,
type = "latex",
summary = TRUE,
title = "Summary Statistics",
out = "summary_stats.tex")
# Data preparation, as for some reason my excel data is not in right format
df <- df %>%
mutate(
country = as.character(country),
year = as.integer(year),
fatalities = as.numeric(fatalities),
gdp_pc = as.numeric(gdp_pc),
alcohol = as.numeric(alcohol),
pop_density = as.numeric(pop_density)
)
# Preparation for Synth package
# https://cran.r-project.org/web/packages/Synth/Synth.pdf this manual served me as an example
dataprep_out <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp","urbanization"),
predictors.op = "mean",
time.predictors.prior = 2000:2008,
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = 1,
controls.identifier = setdiff(unique(df$country_id), 1),
time.optimize.ssr = 2000:2008,
time.plot = 2000:2016
)
# Run synthetic control and getting the results
synth_out <- synth(dataprep_out)
synth_tables <- synth.tab(
dataprep.res = dataprep_out,
synth.res = synth_out
)
# Printing results
print("Unit Weights:")
print(synth_tables$tab.w)
print("\nPredictor Balance:")
print(synth_tables$tab.pred)
print("\nMean Squared Prediction Error:")
print(synth_tables$tab.loss)
# Plot results
# Path plot
path.plot(
synth.res = synth_out,
dataprep.res = dataprep_out,
Ylab = "Fatalities",
Xlab = "Year",
Legend = c("Samoa", "Synthetic Samoa"),
Legend.position = "bottomleft",
Main = "Samoa vs Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
# Gap plot (treatment effect)
gaps.plot(
synth.res = synth_out,
dataprep.res = dataprep_out,
Ylab = "Gap in Fatalities",
Xlab = "Year",
Main = "Gap between Samoa and Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
abline(h = 0, lty = 2, col = "gray")
# Treatment effects
# Extracting actual and synthetic values
actual <- dataprep_out$Y1plot
synthetic <- dataprep_out$Y0plot %*% synth_out$solution.w
treatment_effect <- actual - synthetic
# Post-treatment average effect
post_treatment_effect <- mean(treatment_effect[10:17]) # 2009-2016
print(paste("\nAverage Post-Treatment Effect:", round(post_treatment_effect, 2)))
# Results dataframe
results_df <- data.frame(
year = 2000:2016,
actual = as.vector(actual),
synthetic = as.vector(synthetic),
gap = as.vector(treatment_effect)
)
print("\nYear-by-Year Results:")
print(results_df)
library(Synth)
library(tidyverse)
df <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vT3-OJdccWMr8juZotsPzZDTdONIgQ0IwWqDM7ro9S_FXFpOSIxA5ynKyCUBtZ1l9t83PCBaUv-vOeB/pub?gid=2137587892&single=true&output=csv")
head(df)
# Data preparation, as for some reason my excel data is not in right format
df <- df %>%
mutate(
country = as.character(country),
year = as.integer(year),
fatalities = as.numeric(fatalities),
gdp_pc = as.numeric(gdp_pc),
alcohol = as.numeric(alcohol),
pop_density = as.numeric(pop_density)
)
# Preparation for Synth package
# https://cran.r-project.org/web/packages/Synth/Synth.pdf this manual served me as an example
dataprep_out <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp","urbanization"),
predictors.op = "mean",
time.predictors.prior = 2000:2008,
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = 1,
controls.identifier = setdiff(unique(df$country_id), 1),
time.optimize.ssr = 2000:2008,
time.plot = 2000:2016
)
# Run synthetic control and getting the results
synth_out <- synth(dataprep_out)
synth_tables <- synth.tab(
dataprep.res = dataprep_out,
synth.res = synth_out
)
# Printing results
print("Unit Weights:")
print(synth_tables$tab.w)
print("\nPredictor Balance:")
print(synth_tables$tab.pred)
print("\nMean Squared Prediction Error:")
print(synth_tables$tab.loss)
# Plot results
# Path plot
path.plot(
synth.res = synth_out,
dataprep.res = dataprep_out,
Ylab = "Fatalities",
Xlab = "Year",
Legend = c("Samoa", "Synthetic Samoa"),
Legend.position = "bottomleft",
Main = "Samoa vs Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
# Gap plot (treatment effect)
gaps.plot(
synth.res = synth_out,
dataprep.res = dataprep_out,
Ylab = "Gap in Fatalities",
Xlab = "Year",
Main = "Gap between Samoa and Synthetic Control"
)
abline(v = 2009, lty = 2, col = "red")
abline(h = 0, lty = 2, col = "gray")
# Treatment effects
# Extracting actual and synthetic values
actual <- dataprep_out$Y1plot
synthetic <- dataprep_out$Y0plot %*% synth_out$solution.w
treatment_effect <- actual - synthetic
# Post-treatment average effect
post_treatment_effect <- mean(treatment_effect[10:17]) # 2009-2016
print(paste("\nAverage Post-Treatment Effect:", round(post_treatment_effect, 2)))
# Results dataframe
results_df <- data.frame(
year = 2000:2016,
actual = as.vector(actual),
synthetic = as.vector(synthetic),
gap = as.vector(treatment_effect)
)
print("\nYear-by-Year Results:")
print(results_df)
View(synthetic)
View(synthetic)
View(synth_tables)
# Get control units
control_units <- setdiff(unique(df$country_id), 1)
# Store placebo gaps
placebo_gaps <- list()
# Run placebo for each control unit
for(unit in control_units) {
tryCatch({
# Run synth treating this control unit as treated
dataprep_placebo <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp", "urbanization"),
predictors.op = "mean",
time.predictors.prior = 2000:2008,
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = unit,
controls.identifier = setdiff(control_units, unit),
time.optimize.ssr = 2000:2008,
time.plot = 2000:2016
)
synth_placebo <- synth(dataprep_placebo)
# Calculate gap
actual_p <- dataprep_placebo$Y1plot
synthetic_p <- dataprep_placebo$Y0plot %*% synth_placebo$solution.w
gap_p <- actual_p - synthetic_p
placebo_gaps[[as.character(unit)]] <- as.vector(gap_p)
}, error = function(e) {
cat("Skipped unit", unit, "\n")
})
}
# Create plot
plot(2000:2016, rep(0, 17),
type = "n",
ylim = c(-20, 25),
xlab = "Year",
ylab = "Gap in Fatalities",
main = "Placebo Test: Samoa vs Control Units")
# Plot each placebo in gray
for(gap in placebo_gaps) {
lines(2000:2016, gap, col = "gray70", lwd = 1)
}
# Plot Samoa in red
lines(2000:2016, results_df$gap, col = "red", lwd = 2.5)
# Add reference lines
abline(v = 2009, lty = 2, col = "blue")
abline(h = 0, lty = 2, col = "black")
legend("topleft",
legend = c("Samoa", "Placebo Units"),
col = c("red", "gray70"),
lwd = c(2.5, 1),
bty = "n")
# Post-treatment effect for Samoa
samoa_effect <- mean(results_df$gap[10:17])  # 2009-2016
# Post-treatment effects for placebos
placebo_effects <- sapply(placebo_gaps, function(gap) mean(gap[10:17]))
# P-value: proportion of placebos with effect >= Samoa's
p_value <- mean(abs(placebo_effects) >= abs(samoa_effect))
cat("\nSamoa's average post-treatment effect:", round(samoa_effect, 2), "\n")
cat("P-value:", round(p_value, 3), "\n")
cat("Number of placebo units:", length(placebo_effects), "\n")
# Test years (excluding actual treatment year 2009)
placebo_years <- c(2003, 2004, 2005, 2006, 2007, 2008, 2010, 2011, 2012)
# Storage for results
time_placebo_results <- list()
# Run synthetic control for each placebo year
for(year in placebo_years) {
# Define pre-treatment period (up to year before placebo treatment)
pre_period <- 2000:(year - 1)
tryCatch({
# Create dataprep with placebo treatment year
dataprep_time_placebo <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp", "urbanization"),
predictors.op = "mean",
time.predictors.prior = pre_period,
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = 1,  # Still Samoa
controls.identifier = setdiff(unique(df$country_id), 1),
time.optimize.ssr = pre_period,
time.plot = 2000:2016
)
# Run synth
synth_time_placebo <- synth(dataprep_time_placebo)
# Calculate gaps
actual_tp <- dataprep_time_placebo$Y1plot
synthetic_tp <- dataprep_time_placebo$Y0plot %*% synth_time_placebo$solution.w
gap_tp <- actual_tp - synthetic_tp
# Store results
time_placebo_results[[as.character(year)]] <- list(
year = year,
gaps = as.vector(gap_tp),
post_treatment_effect = mean(gap_tp[(year - 2000 + 1):17])  # Average after placebo year
)
cat("Completed placebo for year", year, "\n")
}, error = function(e) {
cat("Failed for year", year, ":", e$message, "\n")
})
}
plot(2000:2016, rep(0, 17),
type = "n",
ylim = c(-10, 20),
xlab = "Year",
ylab = "Gap in Fatalities",
main = "In-Time Placebo Test: Different Treatment Years")
# Plot each placebo year in gray
for(result in time_placebo_results) {
lines(2000:2016, result$gaps, col = "gray70", lwd = 1)
abline(v = result$year, lty = 3, col = "gray50")
}
# Plot actual treatment (2009) in red
lines(2000:2016, results_df$gap, col = "red", lwd = 2.5)
abline(v = 2009, lty = 2, col = "red", lwd = 2)
# Add reference line
abline(h = 0, lty = 2, col = "black")
legend("topleft",
legend = c("Actual (2009)", "Placebo Years"),
col = c("red", "gray70"),
lwd = c(2.5, 1),
bty = "n")
# Actual 2009 effect
actual_2009_effect <- mean(results_df$gap[10:17])
# Placebo effects
placebo_year_effects <- sapply(time_placebo_results, function(x) x$post_treatment_effect)
# Create comparison table
comparison_df <- data.frame(
Year = c(2009, as.numeric(names(placebo_year_effects))),
Effect = c(actual_2009_effect, placebo_year_effects),
Type = c("Actual", rep("Placebo", length(placebo_year_effects)))
)
comparison_df <- comparison_df[order(comparison_df$Year), ]
print("\n=== Treatment Effect by Year ===")
print(comparison_df)
# P-value: how many placebo years have effect >= actual effect
p_value_time <- mean(abs(placebo_year_effects) >= abs(actual_2009_effect))
cat("\nP-value (in-time placebo):", round(p_value_time, 3), "\n")
# Run synthetic control pretending treatment was in 2006
dataprep_2006 <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp", "urbanization"),
predictors.op = "mean",
time.predictors.prior = 2000:2005,  # Pre-treatment: 2000-2005
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = 1,
controls.identifier = setdiff(unique(df$country_id), 1),
time.optimize.ssr = 2000:2005,
time.plot = 2000:2016
)
synth_2006 <- synth(dataprep_2006)
# Calculate gaps for 2006 placebo
actual_2006 <- dataprep_2006$Y1plot
synthetic_2006 <- dataprep_2006$Y0plot %*% synth_2006$solution.w
gap_2006 <- actual_2006 - synthetic_2006
plot(2000:2016, gap_2006,
type = "l",
col = "blue",
lwd = 2,
xlab = "Year",
ylab = "Gap in Fatalities",
main = "In-Time Placebo: 2006 vs Actual 2009",
ylim = c(-5, 20))
# Add actual 2009 treatment
lines(2000:2016, results_df$gap, col = "red", lwd = 2)
# Add vertical lines
abline(v = 2006, lty = 2, col = "blue", lwd = 1.5)
abline(v = 2009, lty = 2, col = "red", lwd = 1.5)
abline(h = 0, lty = 2, col = "gray")
legend("topleft",
legend = c("Actual Treatment (2009)", "Placebo Treatment (2006)"),
col = c("red", "blue"),
lwd = 2,
bty = "n")
# Effect at treatment year
effect_2006_at_2006 <- gap_2006[7]  # 2006 gap
effect_2009_at_2009 <- results_df$gap[10]  # 2009 gap
cat("\nEffect at 'treatment' year:\n")
cat("2006 placebo effect:", round(effect_2006_at_2006, 2), "\n")
cat("2009 actual effect:", round(effect_2009_at_2009, 2), "\n")
# Post-treatment average
post_2006_effect <- mean(gap_2006[7:17])  # 2006-2016
post_2009_effect <- mean(results_df$gap[10:17])  # 2009-2016
cat("\nAverage post-'treatment' effect:\n")
cat("2006 placebo:", round(post_2006_effect, 2), "\n")
cat("2009 actual:", round(post_2009_effect, 2), "\n")
# Run synthetic control pretending treatment was in 2006
dataprep_2006 <- dataprep(
foo = as.data.frame(df),
predictors = c("alcohol", "pop_density", "gdp_pp", "urbanization"),
predictors.op = "mean",
time.predictors.prior = 2000:2005,  # Pre-treatment: 2000-2005
dependent = "fatalities",
unit.variable = "country_id",
unit.names.variable = "country",
time.variable = "year",
treatment.identifier = 1,
controls.identifier = setdiff(unique(df$country_id), 1),
time.optimize.ssr = 2000:2005,
time.plot = 2000:2008  # Stop at 2008, before real treatment
)
synth_2006 <- synth(dataprep_2006)
# Calculate gaps for 2006 placebo
actual_2006 <- dataprep_2006$Y1plot
synthetic_2006 <- dataprep_2006$Y0plot %*% synth_2006$solution.w
gap_2006 <- actual_2006 - synthetic_2006
plot(2000:2008, gap_2006,
type = "l",
col = "blue",
lwd = 2,
xlab = "Year",
ylab = "Gap in Fatalities",
main = "In-Time Placebo Test: Pretend Treatment in 2006",
ylim = c(-5, 5))
abline(v = 2006, lty = 2, col = "blue", lwd = 1.5)
abline(h = 0, lty = 2, col = "gray")
# Effect at 2006 (the fake treatment year)
effect_at_2006 <- gap_2006[7]  # 2006 is 7th year (2000-2006)
# Post-2006 average (2006-2008)
post_2006_effect <- mean(gap_2006[7:9])
cat("\nPlacebo test results (fake treatment in 2006):\n")
cat("Effect at 2006:", round(effect_at_2006, 2), "\n")
cat("Average effect 2006-2008:", round(post_2006_effect, 2), "\n")
cat("\nCompare to actual 2009 effect:", round(results_df$gap[10], 2), "\n")
abline(v = 2006, lty = 2, col = "red", lwd = 1.5)
abline(v = 2006, lty = 2, col = "red", lwd = 1.5)
plot(2000:2008, gap_2006,
type = "l",
col = "red",
lwd = 2,
xlab = "Year",
ylab = "Gap in Fatalities",
main = "In-Time Placebo Test: Pretend Treatment in 2006",
ylim = c(-5, 5))
abline(v = 2006, lty = 2, col = "red", lwd = 1.5)
plot(2000:2008, gap_2006,
type = "l",
col = "black",
lwd = 2,
xlab = "Year",
ylab = "Gap in Fatalities",
main = "In-Time Placebo Test: Pretend Treatment in 2006",
ylim = c(-5, 5))
abline(v = 2006, lty = 2, col = "black", lwd = 1.5)
abline(h = 0, lty = 2, col = "gray")
# Effect at 2006 (the fake treatment year)
effect_at_2006 <- gap_2006[7]  # 2006 is 7th year (2000-2006)
# Effect at 2006 (the fake treatment year)
effect_at_2006 <- gap_2006[7]  # 2006 is 7th year (2000-2006)
# Post-2006 average (2006-2008)
post_2006_effect <- mean(gap_2006[7:9])
cat("\nPlacebo test results (fake treatment in 2006):\n")
cat("Effect at 2006:", round(effect_at_2006, 2), "\n")
cat("Average effect 2006-2008:", round(post_2006_effect, 2), "\n")
cat("\nCompare to actual 2009 effect:", round(results_df$gap[10], 2), "\n")
git commit -m "Update README with project overview and methodology"
git status
git
